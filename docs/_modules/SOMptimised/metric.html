
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SOMptimised.metric &#8212; SOMptimised 1.1</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=62ba249389abaaa9ffc34bf36a076bdc1d65ee18" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=f31d14ad54b65d19161ba51d4ffff3a77ae00456"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">SOMptimised 1.1</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../index.html">
                    SOMptimised
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../tutorial/index.html">
   Tutorial/Example
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../tutorial/clustering_iris.html">
     Train the SOM to predict the iris class
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../tutorial/predict_sepal_width.html">
     Predict sepal width
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../tutorial/normalisation.html">
     Of the importance of normalisation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../tutorial/set_and_get.html">
     Set and get extra parameters
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../tutorial/save_and_load.html">
     Save and load SOM
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  ―――――――――――――――
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../API/index.html">
   API
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../API/lr.html">
     Learning strategy submodule
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../API/metric.html">
     Metric submodule
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../API/neighbourhood.html">
     Neighbourhood strategy submodule
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../API/som.html">
     API for the main som module
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/WilfriedMercier/SOMptimised"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/WilfriedMercier/SOMptimised/issues/new?title=Issue%20on%20page%20%2F_modules/SOMptimised/metric.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1></h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <h1>Source code for SOMptimised.metric</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">.. codeauthor:: Wilfried Mercier - IRAP &lt;wilfried.mercier@irap.omp.eu&gt;</span>

<span class="sd">Functions defining the metric used to find the BMU.</span>

<span class="sd">How to include a custom metric ?</span>
<span class="sd">--------------------------------</span>

<span class="sd">To write a **custom metric**, the following signature must be used:</span>
<span class="sd">   </span>
<span class="sd">.. code::</span>
<span class="sd">   </span>
<span class="sd">   def custom_metric(coord1: np.ndarray, coord2: np.ndarray, *args, squared: bool = False, axis: int = 0, **kwargs) -&gt; float:</span>
<span class="sd">      </span>
<span class="sd">Note that in the above signature, ***args** should always correspond to iterable arguments with the same dimension as **coord1** (e.g. uncertainties). On the other hand, **\**kwargs** correspond to additional arguments which do not have to have the same shape as **coord1**.</span>

<span class="sd">Additionally, the function must be able to return either the distance (if :python:`squared = False`) or its squared value (if :python:`squared = True`).</span>

<span class="sd">For instance, assume we want to define a new metric which takes into account errors which can be scaled by a given factor. Such a metric could be written as</span>

<span class="sd">.. code::</span>
<span class="sd">    </span>
<span class="sd">    def new_metric(coord1: np.ndarray, coord2: np.ndarray, errors: np.ndarray, *args, squared: bool = False, axis: int = 0, factor: float = 1.0, **kwargs):</span>
<span class="sd">        </span>
<span class="sd">        diff = (coord1 - coord2)/(error*factor)</span>
<span class="sd">        </span>
<span class="sd">        if squared:</span>
<span class="sd">            return np.sum(diff*diff, axis=axis)</span>
<span class="sd">        else:</span>
<span class="sd">            return np.sqrt(np.sum(diff*diff, axis=axis))</span>
<span class="sd">        </span>
<span class="sd">.. note::</span>
<span class="sd">    </span>
<span class="sd">    Even if not used, it is better to keep the ***args** and **\**kwargs** parameters in the metric declaration.</span>
<span class="sd">    </span>
<span class="sd">A note on normalisation</span>
<span class="sd">-----------------------</span>

<span class="sd">Depending on the metric used, the data may need to be normalised beforehand, and the SOM weight vectors may need to be un-normalised. </span>

<span class="sd">The following metrics need normalised train and test data to give an optimal result:</span>

<span class="sd">- :py:func:`~.euclidianMetric`</span>
<span class="sd">- :py:func:`~.chi2Metric`</span>

<span class="sd">The following metrics need normalised train and test data **and un-normalised SOM initial weight vectors**:</span>
<span class="sd">   </span>
<span class="sd">- :py:func:`~.chi2CigaleMetric`</span>
<span class="sd">   </span>
<span class="sd">To un-normalise the initial values of the SOM weight vectors, the :python:`unormalise_weights=True` argument can be passed to the :py:meth:`~.SOM.fit` method of the SOM, for instance doing:</span>
<span class="sd">   </span>
<span class="sd">.. code:: python</span>

<span class="sd">   som = SOM(m, n, dim, lr=lr, sigma=sigma, metric=chi2CigaleMetric, max_iter=max_iter)</span>
<span class="sd">   som.fit(X, error, epochs=1, shuffle=True, n_jobs=1, unnormalise_weights=False)</span>

<span class="sd">API</span>
<span class="sd">---</span>

<span class="sd">.. The MIT License (MIT)</span>

<span class="sd">    Copyright © 2023 &lt;Wilfried Mercier&gt;</span>

<span class="sd">    Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the “Software”), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:</span>

<span class="sd">    The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</span>

<span class="sd">    THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">from</span>   <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>
<span class="kn">from</span>   <span class="nn">copy</span>   <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">numpy</span>  <span class="k">as</span>     <span class="nn">np</span>
  
<div class="viewcode-block" id="euclidianMetric"><a class="viewcode-back" href="../../API/metric.html#SOMptimised.metric.euclidianMetric">[docs]</a><span class="k">def</span> <span class="nf">euclidianMetric</span><span class="p">(</span><span class="n">coord1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">coord2</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                    <span class="n">squared</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                    <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> 
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    .. codeauthor:: Wilfried Mercier - IRAP &lt;wilfried.mercier@irap.omp.eu&gt;</span>
<span class="sd">    </span>
<span class="sd">    Provide the euclidian distance estimated between **coord1** and **coord2**. The euclidian distance :math:`d` between coordinates :math:`a = (a_i)` and :math:`b = (b_i)` is given by</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>
<span class="sd">    </span>
<span class="sd">       d = \sqrt{\sum_i (a_i - b_i)^2}</span>
<span class="sd">    </span>
<span class="sd">    :param coord1: first array of coordinates</span>
<span class="sd">    :type coord1: `ndarray`_</span>
<span class="sd">    :param coord2: second array of coordinates</span>
<span class="sd">    :type coord2: :python:`int`, :python:`float` or `ndarray`_ [:python:`float`]</span>
<span class="sd">    </span>
<span class="sd">    :param axis: (**Optional**) axis onto which to compute the sum</span>
<span class="sd">    :type axis: :python:`int`</span>
<span class="sd">    </span>
<span class="sd">    :returns: euclidian distance estimated between the two sets of coordinates</span>
<span class="sd">    :rtype: :python:`float`</span>
<span class="sd">    </span>
<span class="sd">    :raises TypeError: if</span>
<span class="sd">    </span>
<span class="sd">    * :python:`not isinstance(coord1, np.ndarray)`</span>
<span class="sd">    * :python:`not isinstance(coord2, np.ndarray)`</span>
<span class="sd">    * :python:`not isinstance(squared, bool)`</span>
<span class="sd">    * :python:`not isinstance(axis, int)`</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">typ</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">coord1</span><span class="p">,</span> <span class="n">coord2</span><span class="p">,</span> <span class="n">squared</span><span class="p">,</span> <span class="n">axis</span><span class="p">],</span> 
                                <span class="p">[</span><span class="s1">&#39;coord1&#39;</span><span class="p">,</span> <span class="s1">&#39;coord2&#39;</span><span class="p">,</span> <span class="s1">&#39;squared&#39;</span><span class="p">,</span> <span class="s1">&#39;axis&#39;</span><span class="p">],</span> 
                                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
                               <span class="p">):</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">typ</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> has type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">param</span><span class="p">)</span><span class="si">}</span><span class="s1"> but it must be </span><span class="si">{</span><span class="n">typ</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
    
    <span class="n">diff</span> <span class="o">=</span> <span class="n">coord1</span> <span class="o">-</span> <span class="n">coord2</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">diff</span><span class="o">*</span><span class="n">diff</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span> <span class="k">if</span> <span class="n">squared</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">diff</span><span class="o">*</span><span class="n">diff</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">))</span></div>

<div class="viewcode-block" id="chi2Metric"><a class="viewcode-back" href="../../API/metric.html#SOMptimised.metric.chi2Metric">[docs]</a><span class="k">def</span> <span class="nf">chi2Metric</span><span class="p">(</span><span class="n">coord1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">coord2</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">error</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
               <span class="n">squared</span><span class="p">:</span> <span class="nb">bool</span>  <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
               <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span>      <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
               <span class="n">no_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
               <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    .. codeauthor:: Wilfried Mercier - IRAP &lt;wilfried.mercier@irap.omp.eu&gt;</span>
<span class="sd">    </span>
<span class="sd">    Provide a :math:`\chi^2` distance estimated between **coord1** and **coord2** using an uncertainty given by **error**. The :math:`\chi^2` distance :math:`d` between coordinates :math:`a = (a_i)` and :math:`b = (b_i)` with error :math:`e = (e_i)` is given by</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>
<span class="sd">    </span>
<span class="sd">       d = \sqrt{\sum_i \left ( \frac{a_i - b_i}{e_i} \right )^2}</span>
<span class="sd">       </span>
<span class="sd">    .. note::</span>
<span class="sd">       </span>
<span class="sd">       If one of the coordinates in **error** is 0, the :math:`\chi^2` distance will diverge.</span>
<span class="sd">    </span>
<span class="sd">    :param coord1: first array of coordinates</span>
<span class="sd">    :type coord1: `ndarray`_</span>
<span class="sd">    :param coord2: second array of coordinates</span>
<span class="sd">    :type coord2: :python:`int`, :python:`float` or `ndarray`_ [:python:`float`]</span>
<span class="sd">    :param error: array of uncertainties. Must have the same shape as **coord1**. To provide no error, set **no_error** to :python:`True`.</span>
<span class="sd">    :type error: `ndarray`_ [:python:`float`]</span>
<span class="sd">    </span>
<span class="sd">    :param squared: (**Optional**) whether to return the square of the metric or not</span>
<span class="sd">    :type squared: :python:`bool`</span>
<span class="sd">    :param axis: (**Optional**) axis onto which to compute the sum</span>
<span class="sd">    :type axis: :python:`int`</span>
<span class="sd">    :param no_error: (**Optional**) whether to use no error in the computation (i.e. Euclidian distance or not)</span>
<span class="sd">    :type no_error: :python:`bool`</span>
<span class="sd">    </span>
<span class="sd">    :returns: euclidian distance estimated between the two sets of coordinates</span>
<span class="sd">    :rtype: :python:`float`</span>
<span class="sd">    </span>
<span class="sd">    :raises TypeError: if</span>
<span class="sd">    </span>
<span class="sd">    * :python:`not isinstance(no_error, bool)`</span>
<span class="sd">    * :python:`not isinstance(coord1, np.ndarray)`</span>
<span class="sd">    * :python:`not isinstance(coord2, np.ndarray)`</span>
<span class="sd">    * :python:`not isinstance(error, (np.ndarray, int, float))`</span>
<span class="sd">    * :python:`not isinstance(squared, bool)`</span>
<span class="sd">    * :python:`not isinstance(axis, int)`</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">no_error</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
       <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;no_error parameter has type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">no_error</span><span class="p">)</span><span class="si">}</span><span class="s1"> but it must be a bool.&#39;</span><span class="p">)</span>
    
    <span class="c1"># If no error is provided, we set it to 1.0 (similar to computing the Euclidian distance)</span>
    <span class="k">if</span> <span class="n">no_error</span><span class="p">:</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">coord1</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    
    <span class="c1"># Check type for all parameters including the additional arguments</span>
    <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">typ</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">coord1</span><span class="p">,</span> <span class="n">coord2</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">squared</span><span class="p">,</span> <span class="n">axis</span><span class="p">],</span> 
                                <span class="p">[</span><span class="s1">&#39;coord1&#39;</span><span class="p">,</span> <span class="s1">&#39;coord2&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;squared&#39;</span><span class="p">,</span> <span class="s1">&#39;axis&#39;</span><span class="p">],</span> 
                                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="p">),</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
                               <span class="p">):</span>
       
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">typ</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> has type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">param</span><span class="p">)</span><span class="si">}</span><span class="s1"> but it must be </span><span class="si">{</span><span class="n">typ</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">coord1</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">error</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;coord1 parameter has shape </span><span class="si">{</span><span class="n">coord1</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1"> and error parameter has shape </span><span class="si">{</span><span class="n">error</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1"> when they should be similar.&#39;</span><span class="p">)</span>
          
    <span class="n">chi2_all</span> <span class="o">=</span> <span class="p">(</span><span class="n">coord1</span> <span class="o">-</span> <span class="n">coord2</span><span class="p">)</span><span class="o">/</span><span class="n">error</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">chi2_all</span><span class="o">*</span><span class="n">chi2_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span> <span class="k">if</span> <span class="n">squared</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">chi2_all</span><span class="o">*</span><span class="n">chi2_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">))</span></div>

<div class="viewcode-block" id="chi2MetricPenalised"><a class="viewcode-back" href="../../API/metric.html#SOMptimised.metric.chi2MetricPenalised">[docs]</a><span class="k">def</span> <span class="nf">chi2MetricPenalised</span><span class="p">(</span><span class="n">coord1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">coord2</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">error</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                        <span class="n">multFac</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="n">squared</span><span class="p">:</span> <span class="nb">bool</span>              <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                        <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span>                  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="n">no_error</span><span class="p">:</span> <span class="nb">bool</span>             <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    .. codeauthor:: Wilfried Mercier - IRAP &lt;wilfried.mercier@irap.omp.eu&gt;</span>
<span class="sd">    </span>
<span class="sd">    Provide a :math:`\chi^2` distance estimated between **coord1** and **coord2** using an uncertainty given by **error**. The :math:`\chi^2` distance :math:`d` between coordinates :math:`a = (a_i)` and :math:`b = (b_i)` with error :math:`e = (e_i)` is given by</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>
<span class="sd">    </span>
<span class="sd">       d = \sqrt{\sum_{i &gt; 0} \left ( \frac{a_i - b_i}{e_i} \right )^2 \times \exp \lbrace | m (a_0 - b_0) / e_0 | \rbrace}</span>
<span class="sd">       </span>
<span class="sd">    .. important::</span>

<span class="sd">       This metric includes a penalty function (taken as exponential ) for the first coordinate (e.g. for a redshift). For no penalty, use instead :py:func:`~.chi2Metric`.</span>
<span class="sd">       </span>
<span class="sd">    .. note::</span>
<span class="sd">       </span>
<span class="sd">       If one of the coordinates in **error** is 0, the :math:`\chi^2` distance will diverge.</span>
<span class="sd">    </span>
<span class="sd">    :param coord1: first array of coordinates with the first column penalised</span>
<span class="sd">    :type coord1: `ndarray`_</span>
<span class="sd">    :param coord2: second array of coordinates with the first column penalised</span>
<span class="sd">    :type coord2: :python:`int`, :python:`float` or `ndarray`_ [:python:`float`]</span>
<span class="sd">    :param error: array of uncertainties (first column used in the penalty function). Must have the same shape as **coord1**. To provide no error, set **no_error** to :python:`True`.</span>
<span class="sd">    :type error: `ndarray`_ [:python:`float`]</span>
<span class="sd">    </span>
<span class="sd">    :param multFac: (**Optional**) multiplicative factor in the penalty function (see definition above)</span>
<span class="sd">    :type multFac: :python:`int` or :python:`float`</span>
<span class="sd">    :param squared: (**Optional**) whether to return the square of the metric or not</span>
<span class="sd">    :type squared: :python:`bool`</span>
<span class="sd">    :param axis: (**Optional**) axis onto which to compute the sum</span>
<span class="sd">    :type axis: :python:`int`</span>
<span class="sd">    :param no_error: (**Optional**) whether to use no error in the computation (i.e. Euclidian distance or not)</span>
<span class="sd">    :type no_error: :python:`bool`</span>
<span class="sd">    </span>
<span class="sd">    :returns: euclidian distance estimated between the two sets of coordinates</span>
<span class="sd">    :rtype: :python:`float`</span>
<span class="sd">    </span>
<span class="sd">    :raises TypeError: if</span>
<span class="sd">    </span>
<span class="sd">    * :python:`not isinstance(no_error, bool)`</span>
<span class="sd">    * :python:`not isinstance(coord1, np.ndarray)`</span>
<span class="sd">    * :python:`not isinstance(coord2, np.ndarray)`</span>
<span class="sd">    * :python:`not isinstance(multFac, (int, float))`</span>
<span class="sd">    * :python:`not isinstance(error, (np.ndarray, int, float))`</span>
<span class="sd">    * :python:`not isinstance(squared, bool)`</span>
<span class="sd">    * :python:`not isinstance(axis, int)`</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">no_error</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
       <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;no_error parameter has type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">no_error</span><span class="p">)</span><span class="si">}</span><span class="s1"> but it must be a bool.&#39;</span><span class="p">)</span>
    
    <span class="c1"># If no error is provided, we set it to 1.0 (similar to computing the Euclidian distance)</span>
    <span class="k">if</span> <span class="n">no_error</span><span class="p">:</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">coord1</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    
    <span class="c1"># Check type for all parameters including the additional arguments</span>
    <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">typ</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">coord1</span><span class="p">,</span> <span class="n">coord2</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">squared</span><span class="p">,</span> <span class="n">axis</span><span class="p">],</span> 
                                <span class="p">[</span><span class="s1">&#39;coord1&#39;</span><span class="p">,</span> <span class="s1">&#39;coord2&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;squared&#39;</span><span class="p">,</span> <span class="s1">&#39;axis&#39;</span><span class="p">],</span> 
                                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="p">),</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
                               <span class="p">):</span>
       
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">typ</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> has type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">param</span><span class="p">)</span><span class="si">}</span><span class="s1"> but it must be </span><span class="si">{</span><span class="n">typ</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">coord1</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">error</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;coord1 parameter has shape </span><span class="si">{</span><span class="n">coord1</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1"> and error parameter has shape </span><span class="si">{</span><span class="n">error</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1"> when they should be similar.&#39;</span><span class="p">)</span>
          
    <span class="n">chi2_all</span> <span class="o">=</span> <span class="p">(</span><span class="n">coord1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">coord2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="n">error</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="n">penalty</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">multFac</span> <span class="o">*</span> <span class="p">(</span><span class="n">coord1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">coord2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">error</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">chi2_all</span><span class="o">*</span><span class="n">chi2_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span> <span class="o">*</span> <span class="n">penalty</span> <span class="k">if</span> <span class="n">squared</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">chi2_all</span><span class="o">*</span><span class="n">chi2_all</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span> <span class="o">*</span> <span class="n">penalty</span><span class="p">)</span></div>

<div class="viewcode-block" id="chi2CigaleMetric"><a class="viewcode-back" href="../../API/metric.html#SOMptimised.metric.chi2CigaleMetric">[docs]</a><span class="k">def</span> <span class="nf">chi2CigaleMetric</span><span class="p">(</span><span class="n">coord1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">coord2</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">error</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                     <span class="n">squared</span><span class="p">:</span> <span class="nb">bool</span>  <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                     <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span>      <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                     <span class="n">no_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                     <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    .. codeauthor:: Wilfried Mercier - IRAP &lt;wilfried.mercier@irap.omp.eu&gt;</span>
<span class="sd">    </span>
<span class="sd">    Provide a :math:`\chi^2` distance defined in `Cigale`_ estimated between **coord1** and **coord2** using an uncertainty given by **error**. The :math:`\chi^2` distance :math:`d` between coordinates :math:`a = (a_i)` and :math:`b = (b_i)` with error :math:`e = (e_i)` is given by</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>
<span class="sd">    </span>
<span class="sd">       d = \sqrt{\sum_i \left ( \frac{a_i - \alpha b_i}{e_i} \right )^2}</span>
<span class="sd">       </span>
<span class="sd">    where :math:`\alpha` is a scale factor which is computed by the function as</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>
<span class="sd">        </span>
<span class="sd">        \alpha = \frac{\sum_i a_i b_i / e_i^2}{\sum_i b_i^2 / e_i^2}</span>
<span class="sd">       </span>
<span class="sd">    .. note::</span>
<span class="sd">       </span>
<span class="sd">       If one of the coordinates in **error** is 0, the :math:`\chi^2` distance will diverge.</span>
<span class="sd">    </span>
<span class="sd">    :param coord1: first array of coordinates</span>
<span class="sd">    :type coord1: `ndarray`_</span>
<span class="sd">    :param coord2: second array of coordinates</span>
<span class="sd">    :type coord2: :python:`int`, :python:`float` or `ndarray`_ [:python:`float`]</span>
<span class="sd">    :param error: array of uncertainties. Must have the same shape as **coord1**. To provide no error, set **no_error** to :python:`True`.</span>
<span class="sd">    :type error: `ndarray`_ [:python:`float`]</span>
<span class="sd">    </span>
<span class="sd">    :param squared: (**Optional**) whether to return the square of the metric or not</span>
<span class="sd">    :type squared: :python:`bool`</span>
<span class="sd">    :param axis: (**Optional**) axis onto which to compute the sum</span>
<span class="sd">    :type axis: :python:`int`</span>
<span class="sd">    :param no_error: (**Optional**) whether to use no error in the computation (i.e. Euclidian distance or not)</span>
<span class="sd">    :type no_error: :python:`bool`</span>
<span class="sd">    </span>
<span class="sd">    :returns: euclidian distance estimated between the two sets of coordinates</span>
<span class="sd">    :rtype: :python:`float`</span>
<span class="sd">    </span>
<span class="sd">    :raises TypeError: if</span>
<span class="sd">    </span>
<span class="sd">    * :python:`not isinstance(no_error, bool)`</span>
<span class="sd">    * :python:`not isinstance(coord1, np.ndarray)`</span>
<span class="sd">    * :python:`not isinstance(coord2, np.ndarray)`</span>
<span class="sd">    * :python:`not isinstance(error, (np.ndarray, int, float))`</span>
<span class="sd">    * :python:`not isinstance(squared, bool)`</span>
<span class="sd">    * :python:`not isinstance(axis, int)`</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">no_error</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
       <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;no_error parameter has type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">no_error</span><span class="p">)</span><span class="si">}</span><span class="s1"> but it must be a bool.&#39;</span><span class="p">)</span>
    
    <span class="c1"># If no error is provided, we set it to 1.0 (similar to computing the Euclidian distance)</span>
    <span class="k">if</span> <span class="n">no_error</span><span class="p">:</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">coord1</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    
    <span class="c1"># Check type for all parameters including the additional arguments</span>
    <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">typ</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">coord1</span><span class="p">,</span> <span class="n">coord2</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">squared</span><span class="p">,</span> <span class="n">axis</span><span class="p">],</span> 
                                <span class="p">[</span><span class="s1">&#39;coord1&#39;</span><span class="p">,</span> <span class="s1">&#39;coord2&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;squared&#39;</span><span class="p">,</span> <span class="s1">&#39;axis&#39;</span><span class="p">],</span> 
                                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="p">),</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
                               <span class="p">):</span>
       
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">typ</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> has type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">param</span><span class="p">)</span><span class="si">}</span><span class="s1"> but it must be </span><span class="si">{</span><span class="n">typ</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">coord1</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">error</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;coord1 parameter has shape </span><span class="si">{</span><span class="n">coord1</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1"> and error parameter has shape </span><span class="si">{</span><span class="n">error</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1"> when they should be similar.&#39;</span><span class="p">)</span>
        
    <span class="n">error2</span>   <span class="o">=</span> <span class="n">error</span><span class="o">*</span><span class="n">error</span>
    <span class="n">alpha</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">coord1</span><span class="o">*</span><span class="n">coord2</span><span class="o">/</span><span class="n">error2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">coord2</span><span class="o">*</span><span class="n">coord2</span><span class="o">/</span><span class="n">error2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span> <span class="o">*</span> <span class="n">error</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>  
    
    <span class="k">return</span> <span class="n">chi2Metric</span><span class="p">(</span><span class="n">coord1</span><span class="p">,</span> <span class="n">coord2</span><span class="o">*</span><span class="n">alpha</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> 
                      <span class="n">squared</span>  <span class="o">=</span> <span class="n">squared</span><span class="p">,</span>
                      <span class="n">axis</span>     <span class="o">=</span> <span class="n">axis</span><span class="p">,</span>
                      <span class="n">no_error</span> <span class="o">=</span> <span class="n">no_error</span><span class="p">,</span>
                      <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>



<div class="viewcode-block" id="chi2CigaleMetricPenalised"><a class="viewcode-back" href="../../API/metric.html#SOMptimised.metric.chi2CigaleMetricPenalised">[docs]</a><span class="k">def</span> <span class="nf">chi2CigaleMetricPenalised</span><span class="p">(</span><span class="n">coord1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">coord2</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">error</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                              <span class="n">multFac</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                              <span class="n">squared</span><span class="p">:</span> <span class="nb">bool</span>              <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
                              <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span>                  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                              <span class="n">no_error</span><span class="p">:</span> <span class="nb">bool</span>             <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                              <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="sa">r</span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    .. codeauthor:: Wilfried Mercier - IRAP &lt;wilfried.mercier@irap.omp.eu&gt;</span>
<span class="sd">    </span>
<span class="sd">    Provide a penalised :math:`\chi^2` distance as defined in `Cigale`_ estimated between **coord1** and **coord2** using an uncertainty given by **error**. The penalised :math:`\chi^2` distance :math:`d` between coordinates :math:`a = (a_i)` and :math:`b = (b_i)` with error :math:`e = (e_i)` is given by</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>
<span class="sd">    </span>
<span class="sd">       d = \sqrt{\sum_{i &gt; 0} \left ( \frac{a_i - \alpha b_i}{e_i} \right )^2 \times \exp \lbrace | m (a_0 - b_0) / e_0 | \rbrace}</span>
<span class="sd">       </span>
<span class="sd">    where :math:`m` is the multiplicative factor hyperparameter given by **multFac** and :math:`\alpha` is a scale factor which is computed by the function as</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>
<span class="sd">        </span>
<span class="sd">        \alpha = \frac{\sum_i a_i b_i / e_i^2}{\sum_i b_i^2 / e_i^2}.</span>

<span class="sd">    .. important::</span>

<span class="sd">        This metric therefore includes a penalty function (taken as exponential ) for the first coordinate (e.g. for a redshift). For no penalty, use instead :py:func:`~.chi2CigaleMetric`.</span>
<span class="sd">       </span>
<span class="sd">    .. note::</span>
<span class="sd">       </span>
<span class="sd">       If one of the coordinates in **error** is 0, the :math:`\chi^2` distance will diverge.</span>
<span class="sd">    </span>
<span class="sd">    :param coord1: first array of coordinates where the first column is penalised</span>
<span class="sd">    :type coord1: `ndarray`_</span>
<span class="sd">    :param coord2: second array of coordinates where the first column is penalised</span>
<span class="sd">    :type coord2: :python:`int`, :python:`float` or `ndarray`_ [:python:`float`]</span>
<span class="sd">    :param error: array of uncertainties (first column used in the penalty function). Must have the same shape as **coord1**. To provide no error, set **no_error** to :python:`True`.</span>
<span class="sd">    :type error: `ndarray`_ [:python:`float`]</span>
<span class="sd">    </span>
<span class="sd">    :param multFac: (**Optional**) multiplicative factor in the penalty function (see definition above)</span>
<span class="sd">    :type multFac: :python:`int` or :python:`float`</span>
<span class="sd">    :param squared: (**Optional**) whether to return the square of the metric or not</span>
<span class="sd">    :type squared: :python:`bool`</span>
<span class="sd">    :param axis: (**Optional**) axis onto which to compute the sum</span>
<span class="sd">    :type axis: :python:`int`</span>
<span class="sd">    :param no_error: (**Optional**) whether to use no error in the computation (i.e. Euclidian distance or not)</span>
<span class="sd">    :type no_error: :python:`bool`</span>
<span class="sd">    </span>
<span class="sd">    :returns: euclidian distance estimated between the two sets of coordinates</span>
<span class="sd">    :rtype: :python:`float`</span>
<span class="sd">    </span>
<span class="sd">    :raises TypeError: if</span>
<span class="sd">    </span>
<span class="sd">    * :python:`not isinstance(no_error, bool)`</span>
<span class="sd">    * :python:`not isinstance(coord1, np.ndarray)`</span>
<span class="sd">    * :python:`not isinstance(coord2, np.ndarray)`</span>
<span class="sd">    * :python:`not isinstance(multFac, (int, float))`</span>
<span class="sd">    * :python:`not isinstance(error, (np.ndarray, int, float))`</span>
<span class="sd">    * :python:`not isinstance(squared, bool)`</span>
<span class="sd">    * :python:`not isinstance(axis, int)`</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">no_error</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
       <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;no_error parameter has type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">no_error</span><span class="p">)</span><span class="si">}</span><span class="s1"> but it must be a bool.&#39;</span><span class="p">)</span>
    
    <span class="c1"># If no error is provided, we set it to 1.0 (similar to computing the Euclidian distance)</span>
    <span class="k">if</span> <span class="n">no_error</span><span class="p">:</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">coord1</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    
    <span class="c1"># Check type for all parameters including the additional arguments</span>
    <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">typ</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">coord1</span><span class="p">,</span> <span class="n">coord2</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">multFac</span><span class="p">,</span> <span class="n">squared</span><span class="p">,</span> <span class="n">axis</span><span class="p">],</span> 
                                <span class="p">[</span><span class="s1">&#39;coord1&#39;</span><span class="p">,</span> <span class="s1">&#39;coord2&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;multFac&#39;</span><span class="p">,</span> <span class="s1">&#39;squared&#39;</span><span class="p">,</span> <span class="s1">&#39;axis&#39;</span><span class="p">],</span> 
                                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="p">),</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
                               <span class="p">):</span>
       
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">typ</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> has type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">param</span><span class="p">)</span><span class="si">}</span><span class="s1"> but it must be </span><span class="si">{</span><span class="n">typ</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">coord1</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">error</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;coord1 parameter has shape </span><span class="si">{</span><span class="n">coord1</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1"> and error parameter has shape </span><span class="si">{</span><span class="n">error</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1"> when they should be similar.&#39;</span><span class="p">)</span>
        
    <span class="c1"># We remove the first column from all the computations since it is used for the penalty function instead</span>
    <span class="n">error2</span>                <span class="o">=</span> <span class="n">error</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">*</span><span class="n">error</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="n">alpha</span>                 <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">coord1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">*</span><span class="n">coord2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">/</span><span class="n">error2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">coord2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">*</span><span class="n">coord2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">/</span><span class="n">error2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span> <span class="o">*</span> <span class="n">error</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    
    <span class="n">coord2_scaled</span>         <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">coord2</span><span class="p">)</span>
    <span class="n">coord2_scaled</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">*=</span> <span class="n">alpha</span>
    
    <span class="k">return</span> <span class="n">chi2MetricPenalised</span><span class="p">(</span><span class="n">coord1</span><span class="p">,</span> <span class="n">coord2</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> 
                               <span class="n">multFac</span>  <span class="o">=</span> <span class="n">multFac</span><span class="p">,</span>
                               <span class="n">squared</span>  <span class="o">=</span> <span class="n">squared</span><span class="p">,</span> 
                               <span class="n">axis</span>     <span class="o">=</span> <span class="n">axis</span><span class="p">,</span>
                               <span class="n">no_error</span> <span class="o">=</span> <span class="n">no_error</span><span class="p">,</span>
                               <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
</pre></div>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Wilfried Mercier<br/>
  
      &copy; Copyright 2022, Wilfried Mercier.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>